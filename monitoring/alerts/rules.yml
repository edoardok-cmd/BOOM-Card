groups:
  - name: boomcard_application_health
    rules:
      - alert: BoomCardApiHighLatency
        expr: histogram_quantile(0.99, sum by(le, job, instance) (rate(http_request_duration_seconds_bucket{job="boomcard-api", code!~"5xx|4xx"}[5m]))) > 0.5
        for: 2m
        labels:
          severity: critical
          component: api-gateway
          team: backend
        annotations:
          summary: |
            EN: BOOM Card API high request latency detected on {{ $labels.instance }}.
            BG: Открита е висока латентност на заявките към BOOM Card API на {{ $labels.instance }}.
          description: |
            EN: The 99th percentile of API request duration is above 500ms for the last 2 minutes on {{ $labels.instance }}. This indicates performance degradation impacting user experience.
            BG: 99-тият персентил на продължителността на API заявките е над 500ms през последните 2 минути на {{ $labels.instance }}. Това показва влошаване на производителността, засягащо потребителското изживяване.

      - alert: BoomCardApiHighErrorRate
        expr: |
          sum(rate(http_requests_total{job="boomcard-api", code=~"5.."}[5m]))
          /
          sum(rate(http_requests_total{job="boomcard-api"}[5m]))
          > 0.05
        for: 2m
        labels:
          severity: critical
          component: api-gateway
          team: backend
        annotations:
          summary: |
            EN: BOOM Card API high 5xx error rate detected on {{ $labels.instance }}.
            BG: Открита е висока честота на 5xx грешки в BOOM Card API на {{ $labels.instance }}.
          description: |
            EN: More than 5% of API requests are returning 5xx errors on {{ $labels.instance }} for the last 2 minutes. This indicates significant service issues impacting all platform components.
            BG: Повече от 5% от API заявките връщат 5xx грешки на {{ $labels.instance }} през последните 2 минути. Това показва значителни проблеми в услугата, засягащи всички компоненти на платформата.

      - alert: BoomCardServiceDown
        expr: up{job=~"boomcard-api|boomcard-partner-dashboard|boomcard-admin-panel"} == 0
        for: 1m
        labels:
          severity: critical
          component: core-service
          team: devops
        annotations:
          summary: |
            EN: A BOOM Card core service is down: {{ $labels.job }} on {{ $labels.instance }}.
            BG: Основна услуга на BOOM Card не работи: {{ $labels.job }} на {{ $labels.instance }}.
          description: |
            EN: One or more BOOM Card core services (API, Partner Dashboard, Admin Panel) is reported as down for more than 1 minute. Immediate attention required as this impacts core platform functionality.
            BG: Една или повече основни услуги на BOOM Card (API, Партньорско Табло, Административен Панел) не работят повече от 1 минута. Изисква се незабавно внимание, тъй като това засяга основната функционалност на платформата.

      - alert: BoomCardPaymentFailureRateHigh
        # Assumes custom metrics: boomcard_payment_transactions_total{status="success|failed"}
        expr: |
          sum(rate(boomcard_payment_transactions_total{status="failed"}[5m]))
          /
          sum(rate(boomcard_payment_transactions_total{status=~"success|failed"}[5m]))
          > 0.10
        for: 5m
        labels:
          severity: critical
          component: payment-processing
          team: finance
        annotations:
          summary: |
            EN: High payment transaction failure rate on BOOM Card.
            BG: Висока честота на неуспешни платежни транзакции в BOOM Card.
          description: |
            EN: More than 10% of payment transactions have failed over the last 5 minutes. This directly impacts revenue and user trust. Immediate investigation required.
            BG: Повече от 10% от платежните транзакции са неуспешни през последните 5 минути. Това пряко влияе на приходите и доверието на потребителите. Необходима е незабавна проверка.

      - alert: BoomCardSubscriptionProcessingErrors
        # Assumes custom metrics: boomcard_subscription_processing_errors_total
        expr: sum(rate(boomcard_subscription_processing_errors_total[5m])) > 0
        for: 5m
        labels:
          severity: critical
          component: subscription-management
          team: finance
        annotations:
          summary: |
            EN: BOOM Card Subscription processing errors detected.
            BG: Открити са грешки при обработката на абонаменти в BOOM Card.
          description: |
            EN: Errors detected in subscription processing for the last 5 minutes. This could lead to billing issues and service interruptions for subscribers.
            BG: Открити са грешки при обработката на абонаменти през последните 5 минути. Това може да доведе до проблеми с таксуването и прекъсване на услугите за абонатите.

      - alert: BoomCardLoginFailureRateHigh
        # Assumes custom metrics: boomcard_login_attempts_total{status="success|failed"}
        expr: |
          sum(rate(boomcard_login_attempts_total{status="failed"}[5m]))
          /
          sum(rate(boomcard_login_attempts_total{status=~"success|failed"}[5m]))
          > 0.20
        for: 5m
        labels:
          severity: warning
          component: authentication
          team: security
        annotations:
          summary: |
            EN: High user login failure rate detected. Potential brute-force or misconfiguration.
            BG: Открита е висока честота на неуспешни потребителски влизания. Възможна атака или грешна конфигурация.
          description: |
            EN: More than 20% of login attempts are failing over the last 5 minutes. This could indicate a brute-force attack, bot activity, or an issue with the authentication service.
            BG: Повече от 20% от опитите за влизане са неуспешни през последните 5 минути. Това може да е индикация за атака с груба сила, активност на ботове или проблем с услугата за удостоверяване.

      - alert: BoomCardAdminPanelErrorVolume
        # Assumes specific error counter for admin panel internal logic
        expr: sum(rate(boomcard_admin_panel_errors_total[5m])) > 5
        for: 2m
        labels:
          severity: warning
          component: admin-panel
          team: operations
        annotations:
          summary: |
            EN: Elevated error count in BOOM Card Admin Panel.
            BG: Повишен брой грешки в Административния панел на BOOM Card.
          description: |
            EN: More than 5 errors detected in the Admin Panel over the last 5 minutes. This might indicate operational issues for administrators or data inconsistencies.
            BG: Открити са повече от 5 грешки в Административния панел през последните 5 минути. Това може да показва оперативни проблеми за администраторите или несъответствия в данните.

  - name: boomcard_infrastructure_health
    rules:
      - alert: BoomCardHighCpuUsage
        expr: 100 - (avg by (instance, job) (rate(node_cpu_seconds_total{mode="idle", job=~"boomcard-api|boomcard-db|boomcard-redis"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: critical
          component: infrastructure
          team: devops
        annotations:
          summary: |
            EN: High CPU usage on {{ $labels.job }} ({{ $labels.instance }}).
            BG: Високо натоварване на процесора на {{ $labels.job }} ({{ $labels.instance }}).
          description: |
            EN: CPU usage on instance {{ $labels.instance }} ({{ $labels.job }}) has been above 80% for the last 5 minutes. This can lead to service degradation and unresponsiveness.
            BG: Използването на процесора на инстанция {{ $labels.instance }} ({{ $labels.job }}) е над 80% през последните 5 минути. Това може да доведе до влошаване на услугата и неотзивчивост.

      - alert: BoomCardHighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
        for: 5m
        labels:
          severity: critical
          component: infrastructure
          team: devops
        annotations:
          summary: |
            EN: High memory usage on {{ $labels.instance }}.
            BG: Високо натоварване на паметта на {{ $labels.instance }}.
          description: |
            EN: Memory usage on instance {{ $labels.instance }} has been above 85% for the last 5 minutes. This can lead to system instability, crashes, or out-of-memory errors.
            BG: Използването на паметта на инстанция {{ $labels.instance }} е над 85% през последните 5 минути. Това може да доведе до системна нестабилност, сривове или грешки от недостиг на памет.

      - alert: BoomCardDiskSpaceLow
        expr: (node_filesystem_avail_bytes{mountpoint="/", fstype!="tmpfs"} / node_filesystem_size_bytes{mountpoint="/", fstype!="tmpfs"}) * 100 < 10
        for: 10m
        labels:
          severity: critical
          component: infrastructure
          team: devops
        annotations:
          summary: |
            EN: Disk space low on {{ $labels.instance }}.
            BG: Недостатъчно дисково пространство на {{ $labels.instance }}.
          description: |
            EN: Available disk space on {{ $labels.instance }} (mountpoint {{ $labels.mountpoint }}) is less than 10% for the last 10 minutes. This can prevent logging, new data storage, and lead to service failures.
            BG: Наличното дисково пространство на {{ $labels.instance }} (точка на монтиране {{ $labels.mountpoint }}) е по-малко от 10% през последните 10 минути. Това може да попречи на записването на логове, съхранението на нови данни и да доведе до сривове на услугите.

  - name: boomcard_database_health
    rules:
      - alert: BoomCardPostgresDown
        expr: pg_up{job="boomcard-db"} == 0
        for: 1m
        labels:
          severity: critical
          component: database
          team: devops
        annotations:
          summary: |
            EN: PostgreSQL database instance is down on {{ $labels.instance }}.
            BG: Инстанцията на базата данни PostgreSQL не работи на {{ $labels.instance }}.
          description: |
            EN: The PostgreSQL database instance on {{ $labels.instance }} is unreachable for more than 1 minute. This will cause complete platform outage.
            BG: Инстанцията на базата данни PostgreSQL на {{ $labels.instance }} е недостъпна повече от 1 минута. Това ще доведе до пълен срив на платформата.

      - alert: BoomCardPostgresHighConnections
        expr: sum(pg_stat_activity_count{datname!~"template[01]|postgres"}) > 150 # Example threshold: 150 active connections
        for: 5m
        labels:
          severity: warning
          component: database
          team: backend
        annotations:
          summary: |
            EN: High number of active PostgreSQL connections.
            BG: Висок брой активни връзки към PostgreSQL.
          description: |
            EN: The number of active connections to the PostgreSQL database has been over 150 for the last 5 minutes. This can indicate connection pooling issues, application load, or inefficient queries.
            BG: Броят на активните връзки към базата данни PostgreSQL е над 150 през последните 5 минути. Това може да показва проблеми с пулове за връзки, натоварване на приложението или неефективни заявки.

      - alert: BoomCardPostgresLargeDatabaseSize
        expr: pg_database_size_bytes{datname="boomcard_db"} / (1024*1024*1024) > 500 # Example: boomcard_db size > 500GB
        for: 6h
        labels:
          severity: info
          component: database
          team: devops
        annotations:
          summary: |
            EN: BOOM Card Database size approaching threshold on {{ $labels.instance }}.
            BG: Размерът на базата данни на BOOM Card наближава прага на {{ $labels.instance }}.
          description: |
            EN: The 'boomcard_db' database size on {{ $labels.instance }} has exceeded 500GB for over 6 hours. Consider archiving old data, reviewing data retention policies, or planning for increased storage capacity.
            BG: Размерът на базата данни 'boomcard_db' на {{ $labels.instance }} е над 500GB повече от 6 часа. Помислете за архивиране на стари данни, преглед на политиките за съхранение на данни или планиране на увеличен капацитет за съхранение.

  - name: boomcard_cache_health
    rules:
      - alert: BoomCardRedisDown
        expr: redis_up{job="boomcard-redis"} == 0
        for: 1m
        labels:
          severity: critical
          component: cache
          team: devops
        annotations:
          summary: |
            EN: Redis cache instance is down on {{ $labels.instance }}.
            BG: Инстанцията на Redis кеша не работи на {{ $labels.instance }}.
          description: |
            EN: The Redis cache instance on {{ $labels.instance }} is unreachable for more than 1 minute. This will severely impact application performance and likely cause API errors.
            BG: Инстанцията на Redis кеша на {{ $labels.instance }} е недостъпна повече от 1 минута. Това сериозно ще повлияе на производителността на приложението и вероятно ще причини API грешки.

      - alert: BoomCardRedisHighMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 > 90 # Example threshold: 90% memory usage
        for: 5m
        labels:
          severity: warning
          component: cache
          team: backend
        annotations:
          summary: |
            EN: Redis cache high memory usage on {{ $labels.instance }}.
            BG: Високо използване на паметта от Redis кеша на {{ $labels.instance }}.
          description: |
            EN: Redis memory usage on {{ $labels.instance }} has been above 90% for the last 5 minutes. This can lead to aggressive cache eviction, increased database load, or performance issues.
            BG: Използването на паметта от Redis на {{ $labels.instance }} е над 90% през последните 5 минути. Това може да доведе до агресивно изчистване на кеша, повишено натоварване на базата данни или проблеми с производителността.

      - alert: BoomCardRedisHighLatency
        expr: rate(redis_commands_latency_seconds_sum[5m]) / rate(redis_commands_latency_seconds_count[5m]) > 0.015 # Average latency > 15ms
        for: 2m
        labels:
          severity: warning
          component: cache
          team: backend
        annotations:
          summary: |
            EN: Redis cache average command latency is high on {{ $labels.instance }}.
            BG: Средната латентност на командите на Redis кеша е висока на {{ $labels.instance }}.
          description: |
            EN: Average Redis command latency on {{ $labels.instance }} has been above 15ms for the last 2 minutes. This can significantly impact application response times for cached data.
            BG: Средната латентност на командите на Redis на {{ $labels.instance }} е над 15ms през последните 2 минути. Това може значително да повлияе на времето за отговор на приложението за кеширани данни.